# Домашнее задание к занятию "10.01. Зачем и что нужно мониторить"

## Обязательные задания

**Вопрос:** Вас пригласили настроить мониторинг на проект. На онбординге вам рассказали, что проект представляет из себя платформу для вычислений с выдачей текстовых отчетов, которые сохраняются на диск. Взаимодействие с платформой осуществляется по протоколу http. Также вам отметили, что вычисления загружают ЦПУ. Какой минимальный набор метрик вы выведите в мониторинг и почему?

**Ответ:** Минимальный набор метрик будет выглядеть следующим образом: CPU, RAM, Свободное место на дисках, Доступность web-сервера.  
Мониторинг CPU, RAM необходим для понимания реальной нагрузки на железо.   
Мониторинг состояния дисков с частотой периодичностью опроса (раз в 5 минут), т.к. сервис сохраняет отчеты на диск.   
Мониторинг доступности web-сервера будет включать в себя мониторинг доступности сервера, состояния демона и количество неуспешных ответов пользователям (4хх и 5хх)

**Вопрос:** Менеджер продукта посмотрев на ваши метрики сказал, что ему непонятно что такое RAM/inodes/CPUla. Также он сказал, что хочет понимать, насколько мы выполняем свои обязанности перед клиентами и какое качество обслуживания. Что вы можете ему предложить?

**Ответ:** 
RAM/inodes/CPUla отражают нагрузку на железо (опреативная память и процессор) и количество свободных индексных дескрипторов файловой системы (inode).
Высокая нагрузка на процессор (CPU) или/и недостаток оперативной памяти (RAM) могут привести к проблемам в работе сервера и сервисов находящихся на нем. Недостаток индексных дескрипторов (inode) приведет к невозможности созавать объекты файловой системы(файлы, директории) даже при наличии свободного места на диске.  
 
Для ответа на вопросы бизнеса необходимо ввести 5 метрики:
* SLO - целевой уровень сервиса, который мы хотим предоставить нашим пользователям/клиентам.
* SLA - Соглашение об уровне сервиса, т.е. указать целевой SLO и санкции за невыполнение соглашения. 
* SLA - конкретная величина и правила расчета показателя. 
* MTBF - среднее время между сбоями.
* MTTR - среднее время восстановления сервиса.

Например: Мы определяем уроень доступности нашего сервиса для клиентов в 99% (Сервер может быть недоступен за месяц 7 час. 18 мин). За нарушение этого показателя компания предоставит скидку на сервис в сл. месяце в размере 1% за каждый час превышения недоступности. Среднее время восстановлние сервиса не должно превышать 3 часов, а среднее время между сбоями не менее 1.5 недель ( 256 часов ). 

**Вопрос:**  Вашей DevOps команде в этом году не выделили финансирование на построение системы сбора логов. Разработчики в свою очередь хотят видеть все ошибки, которые выдают их приложения. Какое решение вы можете предпринять в этой ситуации, чтобы разработчики получали ошибки приложения?

**Ответ:** Отсутсвие системы мониторинга несет в себе риски в первую очередь для бизнеса, т.к. при отсутствии данных от объектов управления невозможно оценить состояние ключевых метрик. В подобной ситуации необходимо восстользоваться Open Source решениями. Под задачу разработчиков подойдет - Sentry, для диагностики багов. Для организации комплексной системы мониторинга: состояния серверов и проиложений, можно использвовать например TICK.  

**Вопрос:**  Вы, как опытный SRE, сделали мониторинг, куда вывели отображения выполнения SLA=99% по http кодам ответов. Вычисляете этот параметр по следующей формуле: summ_2xx_requests/summ_all_requests. Данный параметр не поднимается выше 70%, но при этом в вашей системе нет кодов ответа 5xx и 4xx. Где у вас ошибка?


**Ответ:** необходиом изменить формулу расчета, т.к. формула не учитывает ответы с кодом 3хх. 

Корректная формула выглядит сл. образом _(summ_2xx_requests + summ_3xx_requests)/(summ_all_requests)_

## Дополнительное задание

1. код python3-скрипта:

```py
#!/usr/bin/env python3
import os
import datetime
import json

Today = datetime.date.today()
Years = str(Today.year)[2:]
dt_now = datetime.datetime.now()


def file_open_write (name):
    filename = f'{Years}-{Today.month}-{Today.month}-awesome-monitoring.log'
    filepath = '/var/log/' + filename
    if os.path.isfile(filepath) == False:
        delfile = open(filepath, 'w')
        delfile.close()
    fileLog = open(filepath, 'a')
    jsonfile = {str(dt_now): name}
    json.dump(jsonfile, fileLog, indent=2)
    fileLog.close()
    return

listjson = {}

#Средняя загрузка
loadavg = open('/proc/loadavg', 'r')
loadavgdict = loadavg.read().split(' ')
loadavgdict = loadavgdict[:3]
loadavg = ['avg-1min', 'avg-5min', 'avg-15min']
listjson = dict(zip(loadavg, loadavgdict))

#температура
tempproc = open('/sys/class/hwmon/hwmon0/device/hwmon0/device/hwmon0/temp1_input', 'r')
tempproc = tempproc.read()
tempproc = tempproc[:2]
listjson['temperature'] = tempproc

#Время работы 
uptime = open('/proc/uptime', 'r') 
uptime = uptime.read().split(' ')
uptime = int(float(uptime[0]) / 60)
listjson['uptime-min'] = uptime

#RAM
meminfo = open('/proc/meminfo','r')
meminfo = meminfo.read().split('\n')
MemTotal = meminfo[0].split(' ')
MemAvailable = meminfo[2].split(' ')
Memfreeprocent = int(int(MemAvailable[-2]) / int(MemTotal[-2]) * 100)
listjson['memfree %'] = Memfreeprocent

file_open_write(listjson)

```
2. конфигурация cron-расписания:

```bash
* * * * * /script/mon.py
```

3. пример файла:

```json
{
  "2022-08-07 20:47:01.544139": {
    "avg-1min": "0.68",
    "avg-5min": "0.70",
    "avg-15min": "0.66",
    "temperature": "27",
    "uptime-min": 583,
    "memfree %": 53
  }
}{
  "2022-08-07 20:48:01.884992": {
    "avg-1min": "0.75",
    "avg-5min": "0.71",
    "avg-15min": "0.66",
    "temperature": "27",
    "uptime-min": 584,
    "memfree %": 53
  }
}{
  "2022-08-07 20:49:02.217303": {
    "avg-1min": "0.56",
    "avg-5min": "0.64",
    "avg-15min": "0.64",
    "temperature": "27",
    "uptime-min": 585,
    "memfree %": 53
  }
}{
  "2022-08-07 20:50:01.589663": {
    "avg-1min": "0.56",
    "avg-5min": "0.63",
    "avg-15min": "0.63",
    "temperature": "27",
    "uptime-min": 586,
    "memfree %": 53
  }
}{
  "2022-08-07 20:51:01.903735": {
    "avg-1min": "0.66",
    "avg-5min": "0.68",
    "avg-15min": "0.65",
    "temperature": "27",
    "uptime-min": 587,
    "memfree %": 53
  }
}{
  "2022-08-07 20:52:02.274210": {
    "avg-1min": "1.25",
    "avg-5min": "0.79",
    "avg-15min": "0.69",
    "temperature": "27",
    "uptime-min": 588,
    "memfree %": 52
  }
}
```